---
title: "Accessing covariates for ecological modelers using point-based observational data"
author: "Johnathan Evanilla"
date: "8/1/2022"
output: ioslides_presentation
---

## Load Packages

```{r}
suppressPackageStartupMessages({
  # from CRAN
  library(dplyr)
  library(sf)
  library(stars)
  
  # from Github
  library(xyzt)
  library(obpg)
  library(ghrsst)
})

```


## Basic R data tools


##https://cn.dataone.org/cn/v2/resolve/e6dd10e1-baae-4c33-95d3-fc73bbb7c186



```{r}
drift <- read_csv("https://apps-nefsc.fisheries.noaa.gov/drifter/drift_wnerr_2021_1.csv")
```

```{r}
summary(drift)
```

```{r}
drift |> count(ID)
```

```{r}
drift <- drift |> 
  mutate(date = as.Date(paste(2022, MTH, DAY, sep="-")))
```


```{r}
summary(drift)
```
```{r}
str(drift)
```


## Read in South Atlantic Bight (SAB) Points


```{r cars, echo = TRUE}
x <- xyzt::read_calcofi()

x
```

```{r}
glimpse(x)
```

## Change to SF Object

```{r points}
points <- x |>
  select(-depth) |>
  xyzt::as_POINT()

points
```


## Build a URL to the data


```{r}
url <- mur_url("2015-07-06")

url
```

## Open a connection to the data

```{r}
X <- ncdf4::nc_open(url)
```


```{r}
ghrsst::mur_vars(X)
```


## Extract the points

```{r}
covars <- ghrsst::extract(points, 
                          X, 
                          varname = "analysed_sst")

covars
```

## Bind the point data back to the original table

```{r}
(y <- dplyr::bind_cols(x, covars))

y
```


## Extract data for a bounding box

```{r}
bbox <- points |>
  xyzt::as_BBOX()

bbox
```



## Extract the layer of data

```{r}
covars <- ghrsst::extract(bbox, 
                          X, 
                          varname = "analysed_sst")

covars
```

```{r}

par(mfrow = c(1,2))
plot(covars, attr = 'analysed_sst', col = sf.colors(n=8), axes = TRUE, reset = FALSE)
plot(sf::st_geometry(points), add = TRUE, col = "black", pch = 19, cex = 1)

```


## Close the connection

```{r}
ncdf4::nc_close(X)
```

